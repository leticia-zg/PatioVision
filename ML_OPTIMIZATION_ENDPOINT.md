# ü§ñ Endpoint de Otimiza√ß√£o de Distribui√ß√£o ML.NET

## üìå Vis√£o Geral

Foi implementado o endpoint de **Otimiza√ß√£o de Distribui√ß√£o de Motos por P√°tio** usando **ML.NET**, que utiliza Machine Learning para recomendar a melhor redistribui√ß√£o de motos entre p√°tios.

## üéØ Funcionalidade

O endpoint analisa todas as motos dispon√≠veis (ou as especificadas) e recomenda redistribui√ß√µes que:
- Melhoram o equil√≠brio entre p√°tios
- Potencializam a taxa de atendimento
- Reduzem congestionamento em p√°tios lotados
- Otimizam a localiza√ß√£o baseada em padr√µes hist√≥ricos

## üîó Endpoint

### POST `/api/v1/patios/otimizar-distribuicao`

**Autentica√ß√£o:** Requerida (JWT Bearer Token)

**Request Body:**
```json
{
  "motoIds": null,              // Lista de IDs espec√≠ficos ou null para todas
  "apenasDisponiveis": true,    // Considerar apenas motos com status Dispon√≠vel
  "incluirTodasMotos": false    // Incluir motos j√° bem posicionadas
}
```

**Response (200 OK):**
```json
{
  "data": {
    "totalMotosAnalisadas": 5,
    "totalRecomendacoes": 3,
    "recomendacoes": [
      {
        "motoId": "guid",
        "modeloMoto": "PCX",
        "statusAtual": "Disponivel",
        "patioAtualId": "guid",
        "patioAtualNome": "P√°tio Zona Leste",
        "patioRecomendadoId": "guid",
        "patioRecomendadoNome": "P√°tio Zona Sul",
        "scoreAdequacao": 0.85,
        "melhoriaEsperada": 35.0,
        "motivo": "P√°tio especializado em aluguel possui maior demanda; Melhor balanceamento de capacidade entre p√°tios",
        "beneficios": [
          "Redu√ß√£o estimada de 15-20% no tempo de atendimento",
          "Melhor distribui√ß√£o da capacidade entre p√°tios",
          "Aumento da probabilidade de aluguel pela localiza√ß√£o estrat√©gica",
          "Score de adequa√ß√£o: 85.0%"
        ]
      }
    ],
    "estatisticas": {
      "beneficioEsperado": "Otimiza√ß√£o de 3 moto(s) pode reduzir tempo de atendimento em at√© 20%",
      "reducaoTempoMedioAtendimento": 20.0,
      "melhoriaBalanceamentoPatio": 90.5,
      "patiosAfetados": 4
    }
  },
  "_links": {
    "self": {
      "href": "http://localhost:5000/api/v1/patios/otimizar-distribuicao",
      "method": "POST"
    }
  }
}
```

## üß† Modelo Machine Learning

### Algoritmo
- **Tipo:** Regression (FastTree)
- **Objetivo:** Predizer o score de adequa√ß√£o (0.0 a 1.0) de uma moto em um p√°tio

### Features Utilizadas

#### Features da Moto:
- Modelo da moto (encoded como categoria)
- Status atual (Disponivel, EmManutencao, Alugada)
- Dias desde cadastro
- Tempo m√©dio em cada status

#### Features do P√°tio:
- Categoria do p√°tio (SemPlaca, Manutencao, Aluguel)
- Localiza√ß√£o geogr√°fica (Latitude, Longitude)
- Capacidade do p√°tio
- Quantidade atual de motos
- Taxa de ocupa√ß√£o
- Taxa de aluguel hist√≥rica

#### Features Temporais:
- Dia da semana
- M√™s do ano
- Hora do dia

### Treinamento
- **Dados Iniciais:** 1000 registros sint√©ticos baseados em heur√≠sticas do dom√≠nio
- **Modelo:** Salvo em `MLModels/OtimizacaoDistribuicao.zip`
- **Nota:** Em produ√ß√£o, o modelo deve ser treinado com dados reais hist√≥ricos

## üìÅ Arquivos Criados/Modificados

### Novos Arquivos:
1. `PatioVision.Core/Models/ML/OtimizacaoDistribuicaoInput.cs` - Modelo de entrada ML
2. `PatioVision.Core/Models/ML/OtimizacaoDistribuicaoOutput.cs` - Modelo de sa√≠da ML
3. `PatioVision.API/DTOs/OtimizacaoDistribuicaoRequest.cs` - DTO de request
4. `PatioVision.API/DTOs/OtimizacaoDistribuicaoResponse.cs` - DTOs de response
5. `PatioVision.Service/Services/ML/OtimizacaoDistribuicaoService.cs` - Servi√ßo ML
6. `PatioVision.API/Controllers/OtimizacaoDistribuicaoController.cs` - Controller

### Arquivos Modificados:
1. `PatioVision.Service/PatioVision.Service.csproj` - Adicionados pacotes ML.NET
2. `PatioVision.API/Program.cs` - Registrado o servi√ßo ML

## üì¶ Pacotes NuGet Adicionados

- `Microsoft.ML` (v3.0.1)
- `Microsoft.ML.FastTree` (v3.0.1)

## üöÄ Como Usar

### 1. Primeira Execu√ß√£o
Na primeira vez que o servi√ßo for executado, o modelo ML ser√° criado automaticamente com dados sint√©ticos.

### 2. Testar o Endpoint

```bash
# Exemplo usando curl
curl -X POST "https://localhost:5000/api/v1/patios/otimizar-distribuicao" \
  -H "Authorization: Bearer SEU_TOKEN_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "apenasDisponiveis": true
  }'
```

### 3. Exemplo com Swagger
1. Execute a aplica√ß√£o
2. Acesse `http://localhost:{porta}/swagger`
3. Expanda o endpoint `POST /api/v1/patios/otimizar-distribuicao`
4. Clique em "Try it out"
5. Preencha o request body (ou deixe vazio para usar padr√µes)
6. Execute e veja as recomenda√ß√µes

## üîß Melhorias Futuras

1. **Treinamento com Dados Reais:**
   - Coletar hist√≥rico de redistribui√ß√µes bem-sucedidas
   - Treinar modelo periodicamente com novos dados
   - Implementar re-treinamento autom√°tico

2. **M√©tricas de Avalia√ß√£o:**
   - R¬≤ score do modelo
   - Mean Absolute Error (MAE)
   - Valida√ß√£o cruzada

3. **Features Adicionais:**
   - Dist√¢ncia geogr√°fica entre p√°tios
   - Hist√≥rico de manuten√ß√µes por modelo
   - Sazonalidade (eventos, feriados)

4. **Otimiza√ß√µes:**
   - Cache de predi√ß√µes
   - Processamento ass√≠ncrono para grandes volumes
   - API de re-treinamento sob demanda

## üìù Notas Importantes

- O modelo atual usa dados sint√©ticos para demonstra√ß√£o
- Em produ√ß√£o, √© essencial treinar com dados reais para melhor precis√£o
- O modelo √© carregado na inicializa√ß√£o do servi√ßo (singleton)
- Recomenda√ß√µes s√£o geradas apenas se houver melhoria significativa (score > atual + 0.1)

## üîç Troubleshooting

**Erro ao carregar modelo:**
- Verifique se a pasta `MLModels` existe e tem permiss√µes de escrita
- O modelo ser√° recriado automaticamente se falhar ao carregar

**Nenhuma recomenda√ß√£o retornada:**
- Verifique se h√° motos dispon√≠veis no banco
- Verifique se os p√°tios est√£o cadastrados
- As recomenda√ß√µes s√≥ aparecem se houver melhoria significativa

---

**Desenvolvido para PatioVision - Sistema de Rastreamento de Motocicletas**

